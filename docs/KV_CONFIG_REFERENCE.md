# Cloudflare KV Configuration Structure

## Overview
KV namespace: `RESORT_CONFIGS`  
Key pattern: `config:{slug}`  
Value type: JSON object

## Schema

### Root Level
```json
{
  "slug": "mountview",
  "name": "Mount View Resort",
  "status": "active",
  "owner": { ... },
  "contact": { ... },
  "booking": { ... },
  "whatsapp": "+919876543210"
}
```

### `status` Field
- `"active"` — Accepts bookings
- `"inactive"` — Rejects bookings (403 error)
- Worker validates: `config.status !== 'active'` → reject

### `owner` Object
```json
{
  "owner": {
    "name": "Owner Name",
    "email": "owner@resort.com",
    "phone": "9876543210",
    "whatsapp": "919876543210"
  }
}
```

**Used for:**
- WhatsApp phone lookup fallback chain (see below)

### `contact` Object
```json
{
  "contact": {
    "email": "info@resort.com",
    "phone": "9876543210",
    "whatsapp": "919876543210"
  }
}
```

**Used for:**
- Alternative phone sources

### `booking` Object (CRITICAL)
```json
{
  "booking": {
    "mode": "sheet",
    "sheetName": "Bookings_2025_12",
    "whatsapp": "919876543210",
    "whatsappTemplate": "Hi {name}! Your booking for {room} from {checkIn} to {checkOut} ({guests} guests) is confirmed. Notes: {notes}"
  }
}
```

#### `booking.mode`
Valid values:
- `"sheet"` — Forward to Google Sheets only
- `"email"` — Forward to Google Sheets only (reserved for future email channel)
- `"both"` — Forward to Google Sheets + (future: email)
- Default: `"email"`

**Critical:** All modes forward to Apps Script webhook. This is the only storage mechanism.

#### `booking.sheetName`
- Optional
- Default: `Bookings_YYYY_MM` (generated by Apps Script)
- Format: `Bookings_{year}_{month}`

#### `booking.whatsapp`
- Phone number for WhatsApp deep link (WhatsApp CTA button)
- Format: Country code + number (no `+` prefix)
- Example: `"919876543210"` (India +91)

#### `booking.whatsappTemplate`
- Message template for WhatsApp button
- Supports placeholders: `{name}`, `{room}`, `{checkIn}`, `{checkOut}`, `{guests}`, `{notes}`
- Example:
  ```
  Hi {name}! Booking confirmed for {room}, {checkIn} to {checkOut}, {guests} guests. {notes}
  ```

### WhatsApp Phone Lookup Chain
Worker attempts to find WhatsApp phone in this order:
```
1. config.booking?.whatsapp
2. config.owner?.whatsapp
3. config.owner?.phone
4. config.contact?.whatsapp
5. config.whatsapp (root level)
```
If none found → no WhatsApp button shown (graceful degradation)

## Example Complete Config

```json
{
  "slug": "mountview",
  "name": "Mount View Resort",
  "status": "active",
  "owner": {
    "name": "John Smith",
    "email": "john@mountview.com",
    "phone": "9876543210",
    "whatsapp": "919876543210"
  },
  "contact": {
    "email": "bookings@mountview.com",
    "phone": "9876543211",
    "whatsapp": "919876543211"
  },
  "booking": {
    "mode": "sheet",
    "sheetName": "Bookings_2025_12",
    "whatsapp": "919876543210",
    "whatsappTemplate": "Hi {name}! Your {room} booking from {checkIn} to {checkOut} ({guests} guests) is confirmed. We'll contact you shortly."
  },
  "whatsapp": "919876543210"
}
```

## Setting KV Values in Wrangler

### Using CLI
```bash
wrangler kv:key put "config:mountview" --path config-mountview.json
```

### Using wrangler.toml
```toml
[[env.production.kv_namespaces]]
binding = "RESORT_CONFIGS"
id = "ddeba62c54d046d69320dcc2ae68a269"
```

### From Worker Code
```javascript
// Read
const config = await env.RESORT_CONFIGS.get(`config:mountview`, { type: 'json' });

// Write (not typically done, but possible)
await env.RESORT_CONFIGS.put(`config:mountview`, JSON.stringify(config));
```

## Validation Rules

| Field | Required | Validation |
|-------|----------|-----------|
| slug | Yes | Alphanumeric, lowercase |
| name | No | String |
| status | No | "active" \| "inactive", default: "active" |
| owner.name | No | String |
| owner.email | No | Valid email format |
| owner.phone | No | 7-20 digits/special chars |
| owner.whatsapp | No | Digits only, 7-20 length |
| contact.* | No | Same as owner |
| booking.mode | No | "sheet" \| "email" \| "both" |
| booking.sheetName | No | String, format Bookings_* |
| booking.whatsapp | No | Digits only |
| booking.whatsappTemplate | No | String with {placeholders} |
| whatsapp | No | Digits only |

## Common Issues

### Bookings Rejected (403)
**Problem:** Worker returns "Bookings are currently unavailable for this resort"

**Cause:** Missing config or `status !== 'active'`

**Fix:**
```bash
# Check if config exists
wrangler kv:key get "config:mountview"

# If missing, create it
wrangler kv:key put "config:mountview" --path config.json

# If status is wrong
# Edit config.json to include "status": "active"
```

### WhatsApp Button Missing
**Problem:** Modal shows no WhatsApp button after booking

**Cause:** `booking.whatsapp` or fallback chain exhausted

**Fix:** Ensure at least one of these is set in config:
- `booking.whatsapp`
- `owner.whatsapp`
- `owner.phone`
- `contact.whatsapp`
- `whatsapp` (root)

### No Row in Sheet
**Problem:** Booking submitted but no row appears in Google Sheets

**Cause:** Apps Script webhook issue (see Apps Script troubleshooting)

**Diagnostics:**
```bash
# Check Worker can reach webhook
curl -X POST "https://script.google.com/..." \
  -H "Content-Type: application/json" \
  -d '{"test": true}'
```

## Testing

### Minimal Valid Config
```json
{
  "slug": "test-resort",
  "status": "active",
  "booking": {
    "mode": "sheet"
  }
}
```

### Full Config with Defaults
```json
{
  "slug": "full-resort",
  "name": "Full Example Resort",
  "status": "active",
  "owner": {
    "name": "Manager",
    "phone": "9876543210",
    "whatsapp": "919876543210"
  },
  "booking": {
    "mode": "sheet",
    "whatsappTemplate": "Hi {name}! Booking confirmed: {checkIn} → {checkOut}"
  }
}
```

---

**Last Updated:** 2025-12-24  
**Phase:** 5 (Frozen)  
**Status:** Production-ready
