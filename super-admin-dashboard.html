<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Super Admin Dashboard - Webzyl</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --color-bg: #f8f9fa;
      --color-surface: #ffffff;
      --color-primary: #2563eb;
      --color-primary-hover: #1d4ed8;
      --color-danger: #dc2626;
      --color-danger-hover: #b91c1c;
      --color-success: #16a34a;
      --color-warning: #ea580c;
      --color-text: #1f2937;
      --color-text-muted: #6b7280;
      --color-border: #e5e7eb;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--color-bg);
      color: var(--color-text);
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .header {
      background: var(--color-surface);
      padding: 1.5rem 2rem;
      box-shadow: var(--shadow-sm);
      margin-bottom: 2rem;
    }

    .header h1 {
      font-size: 1.875rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .header .subtitle {
      color: var(--color-text-muted);
      font-size: 0.875rem;
    }

    .section {
      background: var(--color-surface);
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow-md);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--color-border);
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      color: var(--color-text);
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--color-primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--color-primary-hover);
      box-shadow: var(--shadow-md);
    }

    .btn-danger {
      background: var(--color-danger);
      color: white;
    }

    .btn-danger:hover {
      background: var(--color-danger-hover);
      box-shadow: var(--shadow-md);
    }

    .btn-secondary {
      background: var(--color-border);
      color: var(--color-text);
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .grid {
      display: grid;
      gap: 1.5rem;
    }

    .grid-2 {
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }

    .grid-3 {
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }

    .property-card {
      padding: 1.5rem;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .property-card:hover {
      border-color: var(--color-primary);
      box-shadow: var(--shadow-md);
    }

    .property-card.active {
      border-color: var(--color-primary);
      background: rgba(37, 99, 235, 0.05);
    }

    .property-name {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .property-slug {
      color: var(--color-text-muted);
      font-size: 0.875rem;
      font-family: monospace;
    }

    .alert {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.875rem;
    }

    .alert-success {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #86efac;
    }

    .alert-error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }

    .alert-info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #93c5fd;
    }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge-success {
      background: #dcfce7;
      color: #166534;
    }

    .badge-warning {
      background: #fed7aa;
      color: #9a3412;
    }

    .badge-danger {
      background: #fee2e2;
      color: #991b1b;
    }

    .field-editor {
      display: none;
    }

    .field-editor.active {
      display: block;
    }

    .json-editor {
      font-family: 'Courier New', monospace;
      background: #f9fafb;
      padding: 1rem;
      border-radius: 8px;
      min-height: 300px;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-top: 1.5rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--color-primary) 0%, #1d4ed8 100%);
      color: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: var(--shadow-md);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.875rem;
      opacity: 0.9;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--color-text-muted);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--color-surface);
      border-radius: 12px;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      box-shadow: var(--shadow-lg);
    }

    .modal-header {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .modal-buttons {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 1.5rem;
    }

    #configEditor {
      display: none;
    }

    #configEditor.active {
      display: block;
    }

    .quick-actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }

    .quick-actions .btn {
      font-size: 0.8rem;
      padding: 0.5rem 1rem;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üîê Super Admin Dashboard</h1>
    <p class="subtitle">Full control over all properties and configurations</p>
  </div>

  <div class="container">
    <!-- Properties List -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">üìã All Properties</h2>
      </div>

      <div id="propertiesList" class="loading">
        Loading properties...
      </div>
    </div>

    <!-- Config Editor -->
    <div id="configEditor" class="section">
      <div class="section-header">
        <h2 class="section-title">‚öôÔ∏è Edit Property Configuration</h2>
      </div>

      <div id="alertContainer"></div>

      <!-- Quick Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="statPlan">-</div>
          <div class="stat-label">Plan Tier</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);">
          <div class="stat-value" id="statQuota">-</div>
          <div class="stat-label">WhatsApp Quota</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);">
          <div class="stat-value" id="statStatus">-</div>
          <div class="stat-label">Status</div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <button class="btn btn-secondary" onclick="resetWhatsAppQuota()">üîÑ Reset WhatsApp Quota</button>
        <button class="btn btn-secondary" onclick="showChangeSlugModal()">üîó Change Slug</button>
        <button class="btn btn-danger" onclick="deleteProperty()">üóëÔ∏è Delete Property</button>
      </div>

      <!-- Field Editor Tabs -->
      <div class="grid grid-2" style="margin-top: 2rem;">
        <!-- Basic Info -->
        <div class="form-group">
          <label class="form-label">Property Name</label>
          <input type="text" class="form-input" id="fieldName">
        </div>

        <div class="form-group">
          <label class="form-label">Tagline</label>
          <input type="text" class="form-input" id="fieldTagline">
        </div>

        <div class="form-group">
          <label class="form-label">Plan Tier</label>
          <select class="form-select" id="fieldPlanTier">
            <option value="trial">Trial</option>
            <option value="basic">Basic</option>
            <option value="standard">Standard</option>
            <option value="premium">Premium</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Status</label>
          <select class="form-select" id="fieldStatus">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="suspended">Suspended</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">WhatsApp Number</label>
          <input type="text" class="form-input" id="fieldWhatsapp">
        </div>

        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="fieldEmail">
        </div>

        <div class="form-group">
          <label class="form-label">Phone</label>
          <input type="text" class="form-input" id="fieldPhone">
        </div>

        <div class="form-group">
          <label class="form-label">Base Price</label>
          <input type="number" class="form-input" id="fieldBasePrice">
        </div>

        <div class="form-group">
          <label class="form-label">Category</label>
          <select class="form-select" id="fieldCategory">
            <option value="hotel">Hotel</option>
            <option value="resort">Resort</option>
            <option value="homestay">Homestay</option>
            <option value="villa">Villa</option>
            <option value="apartment">Apartment</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">WhatsApp Quota Used</label>
          <input type="number" class="form-input" id="fieldQuotaWhatsappUsed">
        </div>

        <div class="form-group">
          <label class="form-label">WhatsApp Monthly Quota</label>
          <input type="number" class="form-input" id="fieldQuotaWhatsappMonthly">
        </div>

        <div class="form-group">
          <label class="form-label">Plan Expiry (YYYY-MM-DD)</label>
          <input type="date" class="form-input" id="fieldPlanExpiry">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="form-textarea" id="fieldDescription"></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">Address</label>
        <textarea class="form-textarea" id="fieldAddress" style="min-height: 60px;"></textarea>
      </div>

      <!-- Advanced JSON Editor -->
      <div class="form-group">
        <label class="form-label">‚ö†Ô∏è Advanced: Full JSON Config (Use with caution!)</label>
        <textarea class="form-textarea json-editor" id="jsonEditor"></textarea>
      </div>

      <div class="action-buttons">
        <button class="btn btn-primary" onclick="saveConfig()">üíæ Save All Changes</button>
        <button class="btn btn-secondary" onclick="loadPropertyConfig(currentSlug)">‚Ü∫ Reload Config</button>
      </div>
    </div>
  </div>

  <!-- Change Slug Modal -->
  <div id="changeSlugModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">Change Property Slug</div>
      <div class="form-group">
        <label class="form-label">Current Slug</label>
        <input type="text" class="form-input" id="currentSlugDisplay" readonly>
      </div>
      <div class="form-group">
        <label class="form-label">New Slug</label>
        <input type="text" class="form-input" id="newSlugInput" placeholder="new-property-slug">
        <small style="color: var(--color-text-muted); margin-top: 0.25rem; display: block;">Only lowercase letters, numbers, and hyphens</small>
      </div>
      <div class="modal-buttons">
        <button class="btn btn-secondary" onclick="closeChangeSlugModal()">Cancel</button>
        <button class="btn btn-primary" onclick="confirmChangeSlug()">Change Slug</button>
      </div>
    </div>
  </div>

  <script>
    const ADMIN_TOKEN = 'webzyl-admin-dev-2026'; // Should match wrangler.toml
    let allProperties = [];
    let currentSlug = null;
    let currentConfig = null;

    // Load all properties on page load
    window.addEventListener('DOMContentLoaded', async () => {
      await loadAllProperties();
    });

    async function loadAllProperties() {
      try {
        const response = await fetch('https://webzyl.com/api/admin/workspaces', {
          headers: {
            'X-Admin-Token': ADMIN_TOKEN
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load properties');
        }

        const data = await response.json();
        allProperties = data.sites || [];

        renderPropertiesList();
      } catch (error) {
        console.error('Error loading properties:', error);
        document.getElementById('propertiesList').innerHTML = `
          <div class="alert alert-error">‚ùå Failed to load properties: ${error.message}</div>
        `;
      }
    }

    function renderPropertiesList() {
      const container = document.getElementById('propertiesList');

      if (allProperties.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No properties found</div>';
        return;
      }

      container.innerHTML = `
        <div class="grid grid-3">
          ${allProperties.map(prop => `
            <div class="property-card ${currentSlug === prop.slug ? 'active' : ''}"
                 onclick="loadPropertyConfig('${prop.slug}')">
              <div class="property-name">${prop.name || 'Unnamed Property'}</div>
              <div class="property-slug">${prop.slug}</div>
              <div style="margin-top: 0.5rem;">
                <span class="badge badge-${prop.status === 'active' ? 'success' : 'warning'}">${prop.status || 'unknown'}</span>
                <span class="badge badge-success">${prop.plan_tier || 'trial'}</span>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    async function loadPropertyConfig(slug) {
      currentSlug = slug;
      renderPropertiesList(); // Update active state

      try {
        const response = await fetch(`https://webzyl.com/api/operator/config?slug=${slug}`);

        if (!response.ok) {
          throw new Error('Failed to load config');
        }

        currentConfig = await response.json();

        // Populate form fields
        document.getElementById('fieldName').value = currentConfig.name || '';
        document.getElementById('fieldTagline').value = currentConfig.tagline || '';
        document.getElementById('fieldPlanTier').value = currentConfig.plan_tier || 'trial';
        document.getElementById('fieldStatus').value = currentConfig.status || 'active';
        document.getElementById('fieldWhatsapp').value = currentConfig.contact?.whatsapp || currentConfig.whatsapp || '';
        document.getElementById('fieldEmail').value = currentConfig.contact?.email || currentConfig.email || '';
        document.getElementById('fieldPhone').value = currentConfig.contact?.phone || currentConfig.phone || '';
        document.getElementById('fieldBasePrice').value = currentConfig.basePrice || 0;
        document.getElementById('fieldCategory').value = currentConfig.category || 'hotel';
        document.getElementById('fieldDescription').value = currentConfig.description || '';
        document.getElementById('fieldAddress').value = currentConfig.address || '';
        document.getElementById('fieldQuotaWhatsappUsed').value = currentConfig.quota_whatsapp_used || 0;
        document.getElementById('fieldQuotaWhatsappMonthly').value = currentConfig.quota_whatsapp_monthly || 0;
        document.getElementById('fieldPlanExpiry').value = currentConfig.plan_expiry || '';

        // Populate JSON editor
        document.getElementById('jsonEditor').value = JSON.stringify(currentConfig, null, 2);

        // Update stats
        document.getElementById('statPlan').textContent = (currentConfig.plan_tier || 'trial').toUpperCase();
        document.getElementById('statQuota').textContent = `${currentConfig.quota_whatsapp_used || 0}/${currentConfig.quota_whatsapp_monthly || 0}`;
        document.getElementById('statStatus').textContent = (currentConfig.status || 'active').toUpperCase();

        // Show editor
        document.getElementById('configEditor').classList.add('active');

        showAlert('success', `‚úÖ Loaded config for ${currentConfig.name}`);
      } catch (error) {
        console.error('Error loading config:', error);
        showAlert('error', `‚ùå Failed to load config: ${error.message}`);
      }
    }

    async function saveConfig() {
      if (!currentSlug || !currentConfig) {
        showAlert('error', '‚ùå No property selected');
        return;
      }

      try {
        // Try to parse JSON editor first (if user edited it)
        const jsonText = document.getElementById('jsonEditor').value;
        let updates;

        try {
          const jsonConfig = JSON.parse(jsonText);
          updates = jsonConfig;
        } catch (e) {
          // Fall back to form fields
          updates = {
            name: document.getElementById('fieldName').value,
            tagline: document.getElementById('fieldTagline').value,
            plan_tier: document.getElementById('fieldPlanTier').value,
            status: document.getElementById('fieldStatus').value,
            basePrice: parseInt(document.getElementById('fieldBasePrice').value) || 0,
            category: document.getElementById('fieldCategory').value,
            description: document.getElementById('fieldDescription').value,
            address: document.getElementById('fieldAddress').value,
            quota_whatsapp_used: parseInt(document.getElementById('fieldQuotaWhatsappUsed').value) || 0,
            quota_whatsapp_monthly: parseInt(document.getElementById('fieldQuotaWhatsappMonthly').value) || 0,
            plan_expiry: document.getElementById('fieldPlanExpiry').value,
            contact: {
              whatsapp: document.getElementById('fieldWhatsapp').value,
              email: document.getElementById('fieldEmail').value,
              phone: document.getElementById('fieldPhone').value,
              name: currentConfig.contact?.name || 'Owner'
            }
          };
        }

        const response = await fetch('https://webzyl.com/api/admin/config/update', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Token': ADMIN_TOKEN
          },
          body: JSON.stringify({
            slug: currentSlug,
            updates: updates
          })
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Failed to save config');
        }

        showAlert('success', `‚úÖ Configuration saved successfully! Updated fields: ${result.updated.join(', ')}`);

        // Reload config to reflect changes
        await loadPropertyConfig(currentSlug);
        await loadAllProperties(); // Refresh properties list
      } catch (error) {
        console.error('Error saving config:', error);
        showAlert('error', `‚ùå Failed to save config: ${error.message}`);
      }
    }

    async function resetWhatsAppQuota() {
      if (!currentSlug) {
        showAlert('error', '‚ùå No property selected');
        return;
      }

      if (!confirm('Reset WhatsApp quota to 0?')) return;

      try {
        const response = await fetch('https://webzyl.com/api/admin/quota/reset', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Token': ADMIN_TOKEN
          },
          body: JSON.stringify({
            slug: currentSlug,
            quotaType: 'whatsapp'
          })
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Failed to reset quota');
        }

        showAlert('success', '‚úÖ WhatsApp quota reset successfully!');
        await loadPropertyConfig(currentSlug);
      } catch (error) {
        console.error('Error resetting quota:', error);
        showAlert('error', `‚ùå Failed to reset quota: ${error.message}`);
      }
    }

    function showChangeSlugModal() {
      if (!currentSlug) {
        showAlert('error', '‚ùå No property selected');
        return;
      }

      document.getElementById('currentSlugDisplay').value = currentSlug;
      document.getElementById('newSlugInput').value = '';
      document.getElementById('changeSlugModal').classList.add('active');
    }

    function closeChangeSlugModal() {
      document.getElementById('changeSlugModal').classList.remove('active');
    }

    async function confirmChangeSlug() {
      const newSlug = document.getElementById('newSlugInput').value.trim();

      if (!newSlug) {
        alert('‚ùå Please enter a new slug');
        return;
      }

      if (!/^[a-z0-9-]+$/.test(newSlug)) {
        alert('‚ùå Slug can only contain lowercase letters, numbers, and hyphens');
        return;
      }

      if (!confirm(`Change slug from "${currentSlug}" to "${newSlug}"?\n\nThis will update the property URL!`)) {
        return;
      }

      try {
        const response = await fetch('https://webzyl.com/api/admin/config/change-slug', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Token': ADMIN_TOKEN
          },
          body: JSON.stringify({
            oldSlug: currentSlug,
            newSlug: newSlug
          })
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Failed to change slug');
        }

        showAlert('success', `‚úÖ Slug changed from "${result.oldSlug}" to "${result.newSlug}"!`);
        closeChangeSlugModal();

        currentSlug = newSlug;
        await loadAllProperties();
        await loadPropertyConfig(newSlug);
      } catch (error) {
        console.error('Error changing slug:', error);
        alert(`‚ùå Failed to change slug: ${error.message}`);
      }
    }

    async function deleteProperty() {
      if (!currentSlug) {
        showAlert('error', '‚ùå No property selected');
        return;
      }

      const confirmText = prompt(`‚ö†Ô∏è WARNING: This will permanently delete "${currentSlug}".\n\nType the slug name to confirm:`);

      if (confirmText !== currentSlug) {
        alert('‚ùå Slug does not match. Deletion cancelled.');
        return;
      }

      showAlert('error', '‚ùå Delete endpoint not implemented yet for safety. Use KV dashboard to manually delete.');
    }

    function showAlert(type, message) {
      const alertContainer = document.getElementById('alertContainer');
      const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-error' : 'alert-info';

      alertContainer.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;

      setTimeout(() => {
        alertContainer.innerHTML = '';
      }, 5000);
    }
  </script>
</body>
</html>
